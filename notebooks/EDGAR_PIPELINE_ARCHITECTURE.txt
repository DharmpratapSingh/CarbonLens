================================================================================
                   EDGAR PREPROCESSING PIPELINE ARCHITECTURE
================================================================================

DATA FLOW DIAGRAM
================================================================================

INPUT SOURCES                          PROCESSING PHASES              OUTPUTS
─────────────────────────────────────────────────────────────────────────────

EDGAR TRANSPORT FILES                  PHASE 1A: Combine
├─ bkl_TRANSPORT_emi_nc/               ├─ xr.open_dataset()
│  ├─ EDGAR_v8.0_2000_emi_CO2_AIR.nc  ├─ xr.concat() on time
│  ├─ EDGAR_v8.0_2001_emi_CO2_AIR.nc  └─ Save uncompressed
│  ├─ ...                              ▼
│  └─ EDGAR_v8.0_2023_emi_CO2_AIR.nc   edgar_transport_
                                       2000_2024_rawcombined.nc
                                           │
                                       PHASE 1B: Repair Time
                                       ├─ Verify 288 steps
                                       ├─ Convert to CF-compliant
                                       └─ Save with fixed coords
                                           ▼
                                       edgar_transport_
                                       2000_2024_rawcombined_
                                       fixedtime.nc (MAIN GRID)
                                           │
        ┌─────────────────────────────────┼─────────────────────────┐
        │                                  │                         │
    PHASE 2A: CITIES            PHASE 2B: ADMIN-1         PHASE 2C: COUNTRIES
    ───────────────             ────────────────          ──────────────────
        │                            │                         │
GEO_FILES:                  GEO_FILES:                   GEO_FILES:
├─ GHS_UCDB city            ├─ ne_10m_admin_1           ├─ ne_10m_admin_0
│  polygons (GPKG)          │  states/provinces (SHP)    │  countries (SHP)
│  + BUFFER 30 km           │                           │
├─ ne_10m_admin_0           └─ spatial join:            └─ spatial join:
│  (for ISO3)                  • intersects (primary)      • intersects
└─ spatial ops:               • nearest (fallback,         (NO nearest
    • hybrid join             250 km cap)                  for oceans)
    • intersects                 ▼                            ▼
    • nearest fallback       city_month.parquet         country_month.parquet
    (0-600 km radius)        city_year.parquet          country_year.parquet
      ▼                                                      │
city_month.parquet          admin1_month.parquet           │
city_year.parquet           admin1_year.parquet            │
                                                           │
    + EXPANDED VARIANTS                                    │
    ├─ city_month_expanded.parquet      ┌─────────────────┘
    └─ city_year_expanded.parquet       │
                                        │
                                   PHASE 3: QA
                                   ──────────
                                   ├─ Stamp metadata
                                   ├─ Coverage analysis
                                   │  (compare city/admin1/country
                                   │   vs global totals)
                                   ├─ STL decomposition
                                   └─ COVID-19 impact
                                        │
                                        ├─ Ratio: 85-95%
                                        ├─ Trend/Seasonal
                                        ├─ 2019-2020 change
                                        │
                                        ▼
                                   PHASE 4: Export
                                   ───────────────
                                   ├─ Parquet → CSV
                                   ├─ Consolidated yearly CSV
                                   ├─ Manifest JSON
                                   └─ MCP folder structure
                                        │
                                        ▼
OUTPUT: data/csv_datasets/
├─ city-year/
│  └─ transport_city_year.csv
├─ admin1-year/
│  └─ transport_admin1_year.csv
├─ country-year/
│  └─ transport_country_year.csv
├─ year_all_levels.csv (consolidated)
├─ (+ monthly variants)
├─ (+ expanded variants)
└─ manifest_mcp.json

================================================================================
MODULE DEPENDENCY GRAPH (PROPOSED ARCHITECTURE)
================================================================================

                    sector_config.py
                          │
                ┌─────────┼─────────┐
                │         │         │
         geometry_    time_    spatial_
         loader.py  processing.py  aggregation.py
                │         │         │
                └─────────┼─────────┘
                          │
                ┌─────────┴─────────┐
                │                   │
         aggregation_          batch_
         export.py          processor.py
                │                   │
                └─────────┬─────────┘
                          │
                quality_assurance.py
                          │
         ┌────────────────┴────────────────┐
         │                                 │
    transport_pipeline.py         (future) power_pipeline.py
                                           agriculture_pipeline.py

================================================================================
KEY SPATIAL JOIN ALGORITHMS
================================================================================

HYBRID SPATIAL JOIN (used for Cities)
─────────────────────────────────────

    GRID POINTS                    TARGET GEOMETRIES
    (lat/lon cells)                (City polygons + buffer)
          │                               │
          └───────────┬───────────────────┘
                      │
                  STEP 1: Intersects (Primary)
                  ├─ For each grid point
                  └─ Check if within buffered polygon
                        │
                    YES │ → Assign to city
                        │
                    NO  │ (falls through)
                        │
                      STEP 2: Nearest (Fallback)
                      ├─ For unmatched points
                      ├─ Find nearest city centroid
                      └─ Apply adaptive radius cap
                          (varies by country density)
                            │
                        MATCHED → Assign
                            │
                        UNMATCHED → (Optional Voronoi fill)
                            │
                          OUTPUT: cell_id → city_id mapping


INTERSECTS + NEAREST (used for Admin-1 & Admin-0)
──────────────────────────────────────────────────

    GRID POINTS                    ADMIN BOUNDARIES
    (cell centroids)               (Polygon shapes)
          │                               │
          └───────────┬───────────────────┘
                      │
                  STEP 1: Intersects
                  ├─ Cheap operation (WGS84)
                  └─ high-quality (exact)
                        │
                    COVERAGE    FALLBACK
                    ≥ 95%   │    < 95%
                            │
                            ▼ (project to metric CRS)
                        Nearest Neighbor
                        ├─ max_distance = 250 km cap
                        └─ (EPSG:6933 equal-area)
                            │
                          OUTPUT: cell_id → admin_id mapping
                                + provenance (join_type, distance_m)

================================================================================
TIME AGGREGATION PATTERN
================================================================================

Raw Grid Data (time=288, lat=1800, lon=3600)
        │
        ▼
    Read monthly emissions for each grid cell
        │
        ├─ Extract cell indices that belong to target geometry (e.g., city_id=42)
        ├─ Sum emissions across spatial dimension
        └─ Keep time dimension intact
            │
            ▼ (monthly level)
    DataFrame(columns=[geom_id, year, month, emissions_tonnes, ...])
            │
            ▼ (resample to yearly)
    DataFrame(columns=[geom_id, year, emissions_tonnes, ...])
            │
            ▼ (add derived columns)
    MtCO2 = emissions_tonnes / 1e6
    coverage_pct = <join provenance>
            │
            ▼
    Save as Parquet (analysis) + CSV (MCP)


================================================================================
OUTPUT TABLE SCHEMAS
================================================================================

CITY-LEVEL (city_year.parquet)
──────────────────────────────
Columns:
├─ city_id         (int64)              unique city identifier
├─ city_name       (string)             UCDB city name
├─ admin1_geoid    (string)             Natural Earth Admin-1 ID
├─ admin1_name     (string)             State/Province name
├─ country_name    (string)             Country name
├─ iso3            (string)             ISO 3-letter country code
├─ year            (int16)              2000-2023
├─ emissions_tonnes (float64)           CO2 in tonnes
├─ MtCO2           (float64)            = emissions_tonnes / 1e6
├─ units           (string)             "tonnes CO2"
├─ source          (string)             "EDGAR v2024 transport"
├─ spatial_res     (string)             "0.1°"
└─ (optional) join_type, distance_m     provenance

ADMIN-1 (admin1_year.parquet)
──────────────────────────────
Columns:
├─ admin1_geoid    (string)
├─ admin1_name     (string)
├─ iso3            (string)
├─ country_name    (string)
├─ year            (int16)
├─ emissions_tonnes (float64)
├─ MtCO2           (float64)
├─ units, source, spatial_res
└─ (optional) nearest_share            % of cells matched via nearest

COUNTRY (country_year.parquet)
───────────────────────────────
Columns:
├─ iso3            (string)
├─ country_name    (string)
├─ year            (int16)
├─ emissions_tonnes (float64)
├─ MtCO2           (float64)
├─ units, source, spatial_res
└─ (optional) nearest_share


================================================================================
CONFIGURATION PARAMETERS (sector_config.py)
================================================================================

SECTOR-SPECIFIC:
├─ raw_dir = "bkl_TRANSPORT_emi_nc"     (path to yearly NetCDF files)
├─ output_prefix = "transport"           (for output file names)
├─ variable_name = "emissions"           (NetCDF variable to extract)
└─ time_range = (2000, 2024)             (year boundaries)

UNIVERSAL (same across all sectors):
├─ BATCH_SIZE = 400_000                  (cells per spatial join batch)
├─ CRS_WGS84 = "EPSG:4326"              (geographic coordinates)
├─ CRS_METRIC = "EPSG:6933"             (equal-area projection in meters)
├─ BUFFER_KM = 30                        (city polygon buffer)
├─ MAX_RADIUS_M = {
│   "city": 600_000,                     (~600 km - adaptive by country)
│   "admin1": 250_000,                   (~250 km fallback)
│   "country": 250_000                   (~250 km, rarely used)
│ }
├─ EXP_BUFFER_KM = 40                    (expanded variant)
├─ EXP_MAX_RADIUS_M = {
│   "city": 600_000,
│   "admin1": 350_000,                   (~350 km - wider coverage)
│   "country": 250_000
│ }
└─ VORONOI_FILL = True                  (country-bounded fill for cities)

================================================================================
MEMORY CONSIDERATIONS
================================================================================

Grid size:          1800 lat × 3600 lon = 6.48M cells
Time steps:         288 months
Full dataset:       ~50+ GB uncompressed

Processing strategy:
├─ Read full grid once (combine phase)
├─ Batch spatial operations (400K cells/batch to avoid memory bloat)
├─ Stream-process chunks
└─ Aggregate incrementally

Expected memory usage:
├─ Points GeoDataFrame:    ~1 GB (lat/lon + geometry)
├─ City polygons:          ~100 MB
├─ Admin-1 shapefile:      ~50 MB
├─ Admin-0 shapefile:      ~10 MB
└─ Intermediate joins:     ~2-4 GB per batch

Typical runtime: 2-4 hours (full pipeline, depending on hardware)

================================================================================
